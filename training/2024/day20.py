import numpy as np
from collections import deque
from tqdm import tqdm

example = """
###############
#...#...#.....#
#.#.#.#.#.###.#
#S#...#.#.#...#
#######.#.#.###
#######.#.#...#
#######.#.###.#
###..E#...#...#
###.#######.###
#...###...#...#
#.#####.#.###.#
#.#...#.#.#...#
#.#.#.#.#.#.###
#...#...#...###
###############
"""

actual = """#############################################################################################################################################
#.......#.....#.......#.....#...#.......###...###...###...#...#...###...#...............###...###...........#.............#...#.....#.....###
#.#####.#.###.#.#####.#.###.#.#.#.#####.###.#.###.#.###.#.#.#.#.#.###.#.#.#############.###.#.###.#########.#.###########.#.#.#.###.#.###.###
#.....#.#...#.#.....#.#.#...#.#.#.....#.#...#.#...#.....#...#...#...#.#.#.#...#.........#...#.#...#.........#.......#.....#.#...#...#...#...#
#####.#.###.#.#####.#.#.#.###.#.#####.#.#.###.#.###################.#.#.#.#.#.#.#########.###.#.###.###############.#.#####.#####.#####.###.#
#.....#...#.#.###...#...#...#.#.#.....#.#...#.#...........#.........#.#.#...#.#.#...#...#...#...#...#.......#...###.#...#...#.....#...#.#...#
#.#######.#.#.###.#########.#.#.#.#####.###.#.###########.#.#########.#.#####.#.#.#.#.#.###.#####.###.#####.#.#.###.###.#.###.#####.#.#.#.###
#.#.....#...#...#.........#.#.#.#.....#...#.#.#.....###...#...#...#...#.###...#...#...#...#.....#.###.....#...#...#.#...#.#...#...#.#...#...#
#.#.###.#######.#########.#.#.#.#####.###.#.#.#.###.###.#####.#.#.#.###.###.#############.#####.#.#######.#######.#.#.###.#.###.#.#.#######.#
#...###.....#...###...###.#.#.#.#...#...#...#...#...#...#.....#.#...#...#...#.............###...#.....###.......#.#.#.#...#...#.#...#.......#
###########.#.#####.#.###.#.#.#.#.#.###.#########.###.###.#####.#####.###.###.###############.#######.#########.#.#.#.#.#####.#.#####.#######
#.......###.#.###...#...#.#...#...#.###.........#...#...#.....#.#...#.....#...#...###.........#.......#...###...#...#.#.#...#...#...#.#.....#
#.#####.###.#.###.#####.#.#########.###########.###.###.#####.#.#.#.#######.###.#.###.#########.#######.#.###.#######.#.#.#.#####.#.#.#.###.#
#.....#.....#...#.....#.#.#.........#...#...#...#...#...#.....#.#.#.....#...#...#...#.........#.....#...#...#...#.....#.#.#.......#...#.#...#
#####.#########.#####.#.#.#.#########.#.#.#.#.###.###.###.#####.#.#####.#.###.#####.#########.#####.#.#####.###.#.#####.#.#############.#.###
#...#.......#...#...#.#.#.#.###...#...#...#...#...#...#...#...#...#.....#...#.....#.....###...#.....#.....#...#.#.......#.........#...#.#...#
#.#.#######.#.###.#.#.#.#.#.###.#.#.###########.###.###.###.#.#####.#######.#####.#####.###.###.#########.###.#.#################.#.#.#.###.#
#.#...###...#...#.#...#...#...#.#.#.........#...###.#...#...#.....#...#.....#...#.#.....#...#...###...###...#.#.#.................#.#.#.#...#
#.###.###.#####.#.###########.#.#.#########.#.#####.#.###.#######.###.#.#####.#.#.#.#####.###.#####.#.#####.#.#.#.#################.#.#.#.###
#...#...#...#...#...........#.#.#.#...#...#.#.#...#.#.....#.......#...#...#...#.#.#.....#...#.#...#.#...#...#.#.#...............###.#...#...#
###.###.###.#.#############.#.#.#.#.#.#.#.#.#.#.#.#.#######.#######.#####.#.###.#.#####.###.#.#.#.#.###.#.###.#.###############.###.#######.#
###...#.....#...#...###...#.#.#.#...#...#.#.#.#.#.#.#...#...#.....#.....#...#...#...#...#...#...#.#...#...#...#.#.........#...#.....#.......#
#####.#########.#.#.###.#.#.#.#.#########.#.#.#.#.#.#.#.#.###.###.#####.#####.#####.#.###.#######.###.#####.###.#.#######.#.#.#######.#######
#...#.......#...#.#...#.#.#.#.#.........#.#.#...#.#.#.#...###...#.....#.....#.....#.#...#...#.....###.....#.###.#.#.....#...#.......#.#...###
#.#.#######.#.###.###.#.#.#.#.#########.#.#.#####.#.#.#########.#####.#####.#####.#.###.###.#.###########.#.###.#.#.###.###########.#.#.#.###
#.#.#...#...#...#...#.#.#.#.#.###.......#.#.....#...#.......###.....#...#...#.....#...#.###.#.#...###...#.#.....#.#.#...###...#...#...#.#...#
#.#.#.#.#.#####.###.#.#.#.#.#.###.#######.#####.###########.#######.###.#.###.#######.#.###.#.#.#.###.#.#.#######.#.#.#####.#.#.#.#####.###.#
#.#...#.#.....#.....#...#...#...#.......#.....#...#.........#.......#...#...#.......#.#.#...#.#.#...#.#.#.#.......#.#.....#.#.#.#.....#...#.#
#.#####.#####.#################.#######.#####.###.#.#########.#######.#####.#######.#.#.#.###.#.###.#.#.#.#.#######.#####.#.#.#.#####.###.#.#
#.....#.#...#.................#.###...#.#.....#...#.........#...#...#...#...#.......#.#...#...#...#.#.#.#.#.#.......#.....#.#.#.#.....#...#.#
#####.#.#.#.#################.#.###.#.#.#.#####.###########.###.#.#.###.#.###.#######.#####.#####.#.#.#.#.#.#.#######.#####.#.#.#.#####.###.#
#...#.#...#.....#.............#...#.#.#.#.#...#.....#.......###...#...#.#.#...#.....#.....#.#...#.#...#...#...#.....#.....#.#.#.#.#...#...#.#
#.#.#.#########.#.###############.#.#.#.#.#.#.#####.#.###############.#.#.#.###.###.#####.#.#.#.#.#############.###.#####.#.#.#.#.#.#.###.#.#
#.#.#.........#.#.............#...#.#.#.#.#.#.#...#.#.#...###...#...#.#.#.#.###...#.#...#.#.#.#.#.....#.........###.#.....#.#.#.#.#.#.#...#.#
#.#.#########.#.#############.#.###.#.#.#.#.#.#.#.#.#.#.#.###.#.#.#.#.#.#.#.#####.#.#.#.#.#.#.#.#####.#.###########.#.#####.#.#.#.#.#.#.###.#
#.#...#.......#...............#.....#.#.#.#.#.#.#.#.#.#.#...#.#.#.#.#.#...#...#...#.#.#.#.#.#.#...#...#...#...#...#...#...#.#.#.#...#...#...#
#.###.#.#############################.#.#.#.#.#.#.#.#.#.###.#.#.#.#.#.#######.#.###.#.#.#.#.#.###.#.#####.#.#.#.#.#####.#.#.#.#.#########.###
#...#.#.........#.....#.....#.......#...#.#.#.#.#...#.#.#...#.#.#.#.#.#...#...#...#.#.#.#.#.#.#...#...###...#.#.#.###...#...#...#...#...#...#
###.#.#########.#.###.#.###.#.#####.#####.#.#.#.#####.#.#.###.#.#.#.#.#.#.#.#####.#.#.#.#.#.#.#.#####.#######.#.#.###.###########.#.#.#.###.#
#...#.###...#...#.#...#...#...#.....#.....#.#.#.....#...#...#.#...#.#...#.#...#...#...#...#.#.#.......#.......#.#.....#.......#...#...#.....#
#.###.###.#.#.###.#.#####.#####.#####.#####.#.#####.#######.#.#####.#####.###.#.###########.#.#########.#######.#######.#####.#.#############
#...#.....#...#...#.#...#.#.....#...#.....#.#.#...#...#.....#.#.....#...#.#...#.........#...#.#.......#.........#.....#.....#.#.#.....#.....#
###.###########.###.#.#.#.#.#####.#.#####.#.#.#.#.###.#.#####.#.#####.#.#.#.###########.#.###.#.#####.###########.###.#####.#.#.#.###.#.###.#
###...#...#...#...#...#...#...#...#.....#.#.#.#.#.#...#...#...#.....#.#.#.#...#...#...#.#...#.#...#...###...#.....###...#...#.#...#...#.#...#
#####.#.#.#.#.###.###########.#.#######.#.#.#.#.#.#.#####.#.#######.#.#.#.###.#.#.#.#.#.###.#.###.#.#####.#.#.#########.#.###.#####.###.#.###
#...#.#.#.#.#.#...#.........#...#.......#...#.#.#.#.....#.#.#.......#.#.#...#.#.#.#.#.#.###...#...#.......#.#.........#.#.#...#...#.....#...#
#.#.#.#.#.#.#.#.###.#######.#####.###########.#.#.#####.#.#.#.#######.#.###.#.#.#.#.#.#.#######.###########.#########.#.#.#.###.#.#########.#
#.#.#...#...#...###.......#.#...#...........#.#.#.#...#.#.#.#...#...#.#.....#...#.#.#.#.#.....#.#.....#...#.#.........#...#.#...#.#...#...#.#
#.#.#####################.#.#.#.###########.#.#.#.#.#.#.#.#.###.#.#.#.###########.#.#.#.#.###.#.#.###.#.#.#.#.#############.#.###.#.#.#.#.#.#
#.#.#...###...............#...#...#.......#.#.#.#.#.#.#.#...#...#.#.#.....###...#...#...#...#...#.#...#.#.#.#.............#.#.###...#.#.#...#
#.#.#.#.###.#####################.#.#####.#.#.#.#.#.#.#.#####.###.#.#####.###.#.###########.#####.#.###.#.#.#############.#.#.#######.#.#####
#.#...#...#.....................#.#.....#...#...#.#.#.#.....#.....#.....#.....#.#...........#.....#.....#.#...............#.#.......#.#...###
#.#######.#####################.#.#####.#########.#.#.#####.###########.#######.#.###########.###########.#################.#######.#.###.###
#.......#.###...#.........#.....#.....#...#...###...#.#...#.#...#.......#.....#.#.#...........#.......#...#...............#.........#...#...#
#######.#.###.#.#.#######.#.#########.###.#.#.#######.#.#.#.#.#.#.#######.###.#.#.#.###########.#####.#.###.#############.#############.###.#
#.......#.....#.#.......#...#.......#.#...#.#.#...###...#.#...#.#.....#...#...#.#...#...#...###.....#.#.....#...#.........#...###...###...#.#
#.#############.#######.#####.#####.#.#.###.#.#.#.#######.#####.#####.#.###.###.#####.#.#.#.#######.#.#######.#.#.#########.#.###.#.#####.#.#
#.............#.........#...#.#.....#.#.....#...#.......#.#...#.#.....#...#...#.#...#.#...#.........#.........#...#.....#...#.....#.....#.#.#
#############.###########.#.#.#.#####.#################.#.#.#.#.#.#######.###.#.#.#.#.#############################.###.#.#############.#.#.#
#...........#.....#.....#.#...#.#...#...........#...#...#...#.#.#.#...#...###...#.#.#.....#...#...#...#.........###...#.#.#.............#.#.#
#.#########.#####.#.###.#.#####.#.#.###########.#.#.#.#######.#.#.#.#.#.#########.#.#####.#.#.#.#.#.#.#.#######.#####.#.#.#.#############.#.#
#...#.....#...###.#.###...#...#...#...#...#...#.#.#.#.....#...#.#.#.#.#...#...#...#.....#...#...#...#...#.....#.#.....#...#.............#...#
###.#.###.###.###.#.#######.#.#######.#.#.#.#.#.#.#.#####.#.###.#.#.#.###.#.#.#.#######.#################.###.#.#.#####################.#####
#...#.###...#.#...#...###...#.........#.#...#.#...#...#...#.#...#.#.#...#.#.#...#.....#...###...#.....###...#.#.#.#.........#...........#...#
#.###.#####.#.#.#####.###.#############.#####.#######.#.###.#.###.#.###.#.#.#####.###.###.###.#.#.###.#####.#.#.#.#.#######.#.###########.#.#
#.....#.....#...#.....#...#.............#...#.......#.#.###...#...#...#.#.#.....#.###...#.....#.#...#.......#...#.#.#...###...#...###...#.#.#
#######.#########.#####.###.#############.#.#######.#.#.#######.#####.#.#.#####.#.#####.#######.###.#############.#.#.#.#######.#.###.#.#.#.#
#...###...........#.....#...#.............#...#.....#...#...###.......#...#...#...#...#.......#.....#.....#...#...#...#.......#.#.#...#...#.#
#.#.###############.#####.###.###############.#.#########.#.###############.#.#####.#.#######.#######.###.#.#.#.#############.#.#.#.#######.#
#.#.................#...#.#...#.............#...#...###...#.....#.........#.#.#...#.#.#...###.......#.#...#.#.#.#.............#.#.#...#.....#
#.###################.#.#.#.###.###########.#####.#.###.#######.#.#######.#.#.#.#.#.#.#.#.#########.#.#.###.#.#.#.#############.#.###.#.#####
#.#...........#...#...#.#.#...#.#...........#.....#.....#.......#.......#...#...#...#...#.....#...#...#.....#...#.#...#.......#.#.###.#.....#
#.#.#########.#.#.#.###.#.###.#.#.###########.###########.#############.#####################.#.#.###############.#.#.#.#####.#.#.###.#####.#
#...#.........#.#.#.###...###...#.............#.....#.....#.....###...#.....................#...#.....#.....#...#...#...#.....#.#.....#.....#
#####.#########.#.#.###########################.###.#.#####.###.###.#.#####################.#########.#.###.#.#.#########.#####.#######.#####
#...#.......#...#.#.#...#...###...#...........#...#...#.....#...#...#...#...................#.......#.#...#...#...#...#...#...#...#.....#...#
#.#.#######.#.###.#.#.#.#.#.###.#.#.#########.###.#####.#####.###.#####.#.###################.#####.#.###.#######.#.#.#.###.#.###.#.#####.#.#
#.#.###...#...###...#.#...#...#.#...#...#...#.....###...#...#.....#.....#...........#...#...#.#.....#...#.......#...#...#...#...#.#.......#.#
#.#.###.#.###########.#######.#.#####.#.#.#.#########.###.#.#######.###############.#.#.#.#.#.#.#######.#######.#########.#####.#.#########.#
#.#.#...#.....#...###.....#...#.......#...#.....#...#.#...#.........###.............#.#.#.#...#.......#.......#.###...#...#.....#.#.......#.#
#.#.#.#######.#.#.#######.#.###################.#.#.#.#.###############.#############.#.#.###########.#######.#.###.#.#.###.#####.#.#####.#.#
#.#.#.....#...#.#.....#...#.....#.......#.......#.#.#.#.#.........#...#...........#...#...###...#...#.#.....#.#...#.#.#.#...#...#.#.....#...#
#.#.#####.#.###.#####.#.#######.#.#####.#.#######.#.#.#.#.#######.#.#.###########.#.#########.#.#.#.#.#.###.#.###.#.#.#.#.###.#.#.#####.#####
#.#.....#.#.###.....#...#.....#.#...###...#...###.#...#.#.#.......#.#.###.....###...#.........#...#.#...#...#.....#.#.#.#.....#...#.....#...#
#.#####.#.#.#######.#####.###.#.###.#######.#.###.#####.#.#.#######.#.###.###.#######.#############.#####.#########.#.#.###########.#####.#.#
#...#...#.#...#...#.......###.#...#.........#...#.#...#.#.#.....#...#...#.#...#...###.......#.....#.......#...###...#...#...#...#...###...#.#
###.#.###.###.#.#.###########.###.#############.#.#.#.#.#.#####.#.#####.#.#.###.#.#########.#.###.#########.#.###.#######.#.#.#.#.#####.###.#
#...#...#.#...#.#.........#...#...#.......#...#...#.#...#...#...#.#.....#.#.###.#.#######S#...#...#.........#.....#...#...#...#.#.....#...#.#
#.#####.#.#.###.#########.#.###.###.#####.#.#.#####.#######.#.###.#.#####.#.###.#.#######.#####.###.###############.#.#.#######.#####.###.#.#
#.#...#...#...#.........#.#...#.....#...#...#.......###.....#.#...#.#.....#.#...#.#######.#.....#...#.........#.....#.#.#...###.....#.....#.#
#.#.#.#######.#########.#.###.#######.#.###############.#####.#.###.#.#####.#.###.#######.#.#####.###.#######.#.#####.#.#.#.#######.#######.#
#.#.#.#...#...#...#...#.#.....#.......#.....#...#.....#...#...#...#.#...#...#...#.#######.#.......###.....###...###...#...#...#...#.......#.#
#.#.#.#.#.#.###.#.#.#.#.#######.###########.#.#.#.###.###.#.#####.#.###.#.#####.#.#######.###############.#########.#########.#.#.#######.#.#
#.#.#...#.#.....#.#.#.#.#...#...#...........#.#.#.#...###.#.#...#.#...#.#.#...#.#.#######...###.......###.........#...#.....#...#...#...#...#
#.#.#####.#######.#.#.#.#.#.#.###.###########.#.#.#.#####.#.#.#.#.###.#.#.#.#.#.#.#########.###.#####.###########.###.#.###.#######.#.#.#####
#.#.#.....#.....#...#...#.#.#.###...#...###...#.#.#.#...#.#.#.#.#...#.#.#.#.#.#.#.#########...#.....#.............###...#...#.....#...#.....#
#.#.#.#####.###.#########.#.#.#####.#.#.###.###.#.#.#.#.#.#.#.#.###.#.#.#.#.#.#.#.###########.#####.#####################.###.###.#########.#
#...#.#...#.#...#.....#...#.#.#...#...#.....#...#.#.#.#.#.#.#.#...#.#.#.#.#.#.#.#.#########...###...#.................###.#...###.#.........#
#####.#.#.#.#.###.###.#.###.#.#.#.###########.###.#.#.#.#.#.#.###.#.#.#.#.#.#.#.#.#########.#####.###.###############.###.#.#####.#.#########
#.....#.#.#.#...#...#.#...#...#.#.#...#.....#...#.#.#.#.#.#.#...#.#.#.#.#.#.#.#.#.#########.....#...#.#.............#...#...###...#.........#
#.#####.#.#.###.###.#.###.#####.#.#.#.#.###.###.#.#.#.#.#.#.###.#.#.#.#.#.#.#.#.#.#############.###.#.#.###########.###.#######.###########.#
#.#...#.#.#...#...#.#.#...#.....#...#...###.....#.#...#.#.#.#...#.#.#.#.#.#.#...#.#########.....###...#...........#...#.......#...#...#...#.#
#.#.#.#.#.###.###.#.#.#.###.#####################.#####.#.#.#.###.#.#.#.#.#.#####.#########.#####################.###.#######.###.#.#.#.#.#.#
#.#.#.#.#.#...###...#...###...#.....#...#...#...#...#...#.#.#.#...#.#.#.#.#.#.....#########.###...###...#.........###.......#...#.#.#...#...#
#.#.#.#.#.#.#################.#.###.#.#.#.#.#.#.###.#.###.#.#.#.###.#.#.#.#.#.#############.###.#.###.#.#.#################.###.#.#.#########
#.#.#...#...#.......###...#...#.###...#.#.#.#.#.#...#.#...#.#.#.#...#.#.#.#.#.#.....#######...#.#...#.#.#.......#.....#...#.#...#.#.........#
#.#.#########.#####.###.#.#.###.#######.#.#.#.#.#.###.#.###.#.#.#.###.#.#.#.#.#.###.#########.#.###.#.#.#######.#.###.#.#.#.#.###.#########.#
#...###...#...#...#...#.#.#.....#.......#.#.#.#.#.#...#...#.#.#...#...#.#.#.#.#.#...#########...#...#.#...#...#...#...#.#.#...###...........#
#######.#.#.###.#.###.#.#.#######.#######.#.#.#.#.#.#####.#.#.#####.###.#.#.#.#.#.###############.###.###.#.#.#####.###.#.###################
#.......#...#...#...#...#.......#.......#.#.#.#.#.#...#...#.#.....#...#.#.#.#...#...#######.......#...###.#.#.#...#...#.#.............#...###
#.###########.#####.###########.#######.#.#.#.#.#.###.#.###.#####.###.#.#.#.#######.#######.#######.#####.#.#.#.#.###.#.#############.#.#.###
#.......#...#...###...#...#...#.......#.#.#.#.#.#...#.#.###.#.....###...#.#.......#.#E#####.#...#...#.....#.#.#.#...#...#.....#.....#...#...#
#######.#.#.###.#####.#.#.#.#.#######.#.#.#.#.#.###.#.#.###.#.###########.#######.#.#.#####.#.#.#.###.#####.#.#.###.#####.###.#.###.#######.#
#.......#.#...#.#.....#.#...#...#...#...#.#.#.#.....#.#...#...#...........#.......#.#.#####.#.#.#.###...#...#.#.###...#...###...#...#...#...#
#.#######.###.#.#.#####.#######.#.#.#####.#.#.#######.###.#####.###########.#######.#.#####.#.#.#.#####.#.###.#.#####.#.#########.###.#.#.###
#.#...#...#...#.#.......#...###...#.#...#.#.#.......#.#...#...#...........#.......#.#...###...#.#...#...#...#.#...#...#.........#...#.#.#...#
#.#.#.#.###.###.#########.#.#######.#.#.#.#.#######.#.#.###.#.###########.#######.#.###.#######.###.#.#####.#.###.#.###########.###.#.#.###.#
#.#.#.#.###...#.#.....#...#.........#.#.#.#.#.......#.#.....#.#...........#...#...#...#.......#.#...#.#...#.#.#...#.#.....#...#...#...#.#...#
#.#.#.#.#####.#.#.###.#.#############.#.#.#.#.#######.#######.#.###########.#.#.#####.#######.#.#.###.#.#.#.#.#.###.#.###.#.#.###.#####.#.###
#.#.#...#...#...#...#.#...#.......#...#.#.#.#.......#...#.....#.........#...#.#.#####.#.......#...#...#.#.#.#.#.#...#...#.#.#...#...#...#.###
#.#.#####.#.#######.#.###.#.#####.#.###.#.#.#######.###.#.#############.#.###.#.#####.#.###########.###.#.#.#.#.#.#####.#.#.###.###.#.###.###
#.#...#...#.###.....#.....#.#.....#.#...#.#.#...#...#...#...#...........#.###.#...#...#.......#.....#...#.#.#.#.#...#...#.#.#...#...#...#...#
#.###.#.###.###.###########.#.#####.#.###.#.#.#.#.###.#####.#.###########.###.###.#.#########.#.#####.###.#.#.#.###.#.###.#.#.###.#####.###.#
#.#...#...#.#...#.......#...#.#...#.#...#.#...#.#...#.#...#.#.....#...#...#...#...#...#...#...#.#...#...#.#.#.#.###.#.###...#...#.###...#...#
#.#.#####.#.#.###.#####.#.###.#.#.#.###.#.#####.###.#.#.#.#.#####.#.#.#.###.###.#####.#.#.#.###.#.#.###.#.#.#.#.###.#.#########.#.###.###.###
#...#.....#.#.....#.....#.#...#.#.#.#...#...#...#...#.#.#.#.#.....#.#.#...#.#...###...#.#.#.#...#.#.#...#.#.#.#...#.#.....#.....#...#...#...#
#####.#####.#######.#####.#.###.#.#.#.#####.#.###.###.#.#.#.#.#####.#.###.#.#.#####.###.#.#.#.###.#.#.###.#.#.###.#.#####.#.#######.###.###.#
#.....#...#...###...#...#.#.#...#...#...#...#.....###.#.#.#.#.#.....#.#...#.#.#...#.....#.#.#.#...#.#.###.#.#.#...#.#.....#...#...#...#.....#
#.#####.#.###.###.###.#.#.#.#.#########.#.###########.#.#.#.#.#.#####.#.###.#.#.#.#######.#.#.#.###.#.###.#.#.#.###.#.#######.#.#.###.#######
#.......#...#.#...#...#.#.#.#...#.....#.#.###...#...#.#.#.#.#.#...#...#.#...#...#...#...#.#.#.#.#...#...#.#.#...#...#.....#...#.#...#.......#
###########.#.#.###.###.#.#.###.#.###.#.#.###.#.#.#.#.#.#.#.#.###.#.###.#.#########.#.#.#.#.#.#.#.#####.#.#.#####.#######.#.###.###.#######.#
#...........#...#...#...#.#.....#...#...#.....#...#.#...#.#.#...#.#...#.#.#...#...#...#.#...#...#.#...#.#.#.....#...#.....#...#...#.#.....#.#
#.###############.###.###.#########.###############.#####.#.###.#.###.#.#.#.#.#.#.#####.#########.#.#.#.#.#####.###.#.#######.###.#.#.###.#.#
#.#.............#...#...#.#.......#.#...#.....#...#...###...###...###...#.#.#...#.#...#...###...#...#.#.#...#...#...#.......#...#.#...#...#.#
#.#.###########.###.###.#.#.#####.#.#.#.#.###.#.#.###.###################.#.#####.#.#.###.###.#.#####.#.###.#.###.#########.###.#.#####.###.#
#...#...#.......#...###.#.#.#...#...#.#...###.#.#...#.....#...#...#...###.#.....#.#.#...#.#...#.....#.#.#...#...#...#.......###.#.....#...#.#
#####.#.#.#######.#####.#.#.#.#.#####.#######.#.###.#####.#.#.#.#.#.#.###.#####.#.#.###.#.#.#######.#.#.#.#####.###.#.#########.#####.###.#.#
#.....#...#...#...#.....#.#.#.#.#...#.....#...#.#...#...#.#.#...#...#.....#...#.#.#.#...#...#.....#.#.#.#...#...#...#.......#...#...#...#.#.#
#.#########.#.#.###.#####.#.#.#.#.#.#####.#.###.#.###.#.#.#.###############.#.#.#.#.#.#######.###.#.#.#.###.#.###.#########.#.###.#.###.#.#.#
#...........#...###.......#...#...#.......#.....#.....#...#.................#...#...#.........###...#...###...###...........#.....#.....#...#
#############################################################################################################################################
"""


def make_grid_get_data(
    inp: str,
) -> tuple[np.ndarray, tuple[int, int], tuple[int, int], list]:
    """Builds the initial grid and return start_pos, end_pos, and the locations of hash tags"""
    grid = np.array([list(line) for line in inp.strip().splitlines()], dtype=str)
    nb_rows, nb_cols = grid.shape
    start_pos = end_pos = None
    walls = []
    for r in range(nb_rows):
        for c in range(nb_cols):
            if grid[r, c] == "S":
                start_pos = (r, c)
                grid[start_pos] = "."
            elif grid[r, c] == "E":
                end_pos = (r, c)
                grid[end_pos] = "."
            elif (
                grid[r, c] == "#"
                and not all(  # the new dot needs to be reachable
                    grid[neigh] == "#"
                    for neigh in ((r + 1, c), (r - 1, c), (r, c - 1), (r, c + 1))
                    if 0 <= neigh[0] < nb_rows and 0 <= neigh[1] < nb_cols
                )
                and 0
                < r
                < nb_rows
                - 1  # useless to allow an edge dot because S and E are not on an edge
                and 0
                < c
                < nb_cols
                - 1  # useless to allow an edge dot because S and E are not on an edge
            ):
                walls.append((r, c))
    assert walls
    assert (start_pos is not None) and (end_pos is not None)
    assert np.unique(grid).tolist() == ["#", "."]
    return grid, start_pos, end_pos, walls


def solve_from_pos(
    grid: np.ndarray,
    start_pos: tuple[int, int],
    end_pos: tuple[int, int],
    current_best_score: int | float,
    reference_times: dict[tuple[int, int], int],
    is_reference_run: bool,
    picoseconds_delta: int,
    wall_coord: tuple[int, int],
) -> int | float:
    nb_rows, nb_cols = grid.shape
    curr_score = 0
    queue: deque = deque([])
    has_cheated = False
    queue.append((start_pos, curr_score, has_cheated))
    seen_pos = set()

    while queue:
        curr_pos, curr_score, has_cheated = queue.popleft()
        if curr_pos == wall_coord:
            has_cheated = True
        if curr_pos in seen_pos:  # seen pos during this specific grid solving
            continue
        if (
            is_reference_run is True
            and reference_times.get(curr_pos, float("inf")) > curr_score
        ):
            reference_times[curr_pos] = (
                curr_score  # record the reference time to get to `curr_pos`
            )
        # note: the 2 early exits that follow allowed to cut the run time from ~1'30'' to ~1'00''
        if (
            is_reference_run is False
            and reference_times.get(curr_pos, 0) - curr_score >= picoseconds_delta
        ):
            return float(
                "-inf"
            )  # here we can already return, knowing that this path saves >= 100 picoseconds
        if (
            has_cheated
            and reference_times.get(curr_pos, float("inf")) - curr_score
            < picoseconds_delta
        ):
            return float(
                "inf"
            )  # early return as despite cheating, won't be able to beat ref run by at least 100 picoseconds
        # and therefore should be counted
        if curr_score >= current_best_score:
            seen_pos.add(curr_pos)
            continue
        if curr_pos == end_pos and curr_score < current_best_score:
            current_best_score = curr_score
            # print(f"new best: {current_lowest_score}")
            continue
        seen_pos.add(curr_pos)
        for offset in (-1, 0), (1, 0), (0, 1), (0, -1):
            new_pos = curr_pos[0] + offset[0], curr_pos[1] + offset[1]
            if (
                0 <= new_pos[0] < nb_rows
                and 0 <= new_pos[1] < nb_cols
                and grid[new_pos] == "."
            ):
                queue.append((new_pos, curr_score + 1, has_cheated))
    # print(reference_times)
    return current_best_score


def solve_p1(inp: str, picoseconds_delta: int) -> int:
    grid, start_pos, end_pos, walls = make_grid_get_data(inp)
    reference_times: dict[tuple, int] = {}
    reference_time = solve_from_pos(
        grid,
        start_pos,
        end_pos,
        current_best_score=float("inf"),
        reference_times=reference_times,
        is_reference_run=True,
        picoseconds_delta=picoseconds_delta,
        wall_coord=(-1, -1),  # dummy value as there's no wall in the ref run
    )
    assert isinstance(reference_time, int)
    print(f"{reference_time=} picoseconds")
    ans = 0
    for wall in tqdm(walls):
        assert grid[wall] == "#"
        grid[wall] = "."
        new_time = solve_from_pos(
            grid,
            start_pos, # to speed things up I'd like to start at the wall that was made a ., but this'd need more work
            end_pos,
            current_best_score=reference_time - picoseconds_delta + 1,
            reference_times=reference_times,
            is_reference_run=False,
            picoseconds_delta=picoseconds_delta,
            wall_coord=wall,
        )
        if new_time <= reference_time - picoseconds_delta:
            ans += 1
        grid[wall] = "#"
    print(f"Part 1: {ans}")
    return ans


if __name__ == "__main__":
    assert solve_p1(example, picoseconds_delta=2) == 44
    solve_p1(actual, picoseconds_delta=100)  # ~1 minute: this is slow, can I do better?
